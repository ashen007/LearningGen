
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gen Workflow &#8212; Learn Gen 1.0.0 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Gen.jl Workflow" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Learn Gen 1.0.0 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../index.html">
   Pages
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../introduction/index.html">
     What and Why
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../introduction/What_and_why.html">
       What and Why
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../Gen/index.html">
     Gen.jl
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../Gen/Problems_and_how_gen_solve.html">
       Problems and How Gen Over Come Those
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../language_concepts/index.html">
     Concepts in Genâ€™s Language
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../language_concepts/Concepts_of_gen.html">
       Concepts of Modeling in Gen
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="index.html">
     Gen.jl Workflow
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Gen Workflow
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/Gen_jl/modeling/Workflow.rst.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.rst</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#typical-workflow">
   1. Typical Workflow
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-generative-model">
     1.1. Define Generative Model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#random-choice-expressions">
       1.1.1. Random Choice Expressions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#rules-for-define-generative-function-with-dml">
       1.1.2. Rules For Define Generative Function With DML
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-inference-program">
     1.2. Define Inference Program
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#some-inference-algorithms">
       1.2.1. Some Inference Algorithms
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#importance-sampling">
         1.2.1.1 Importance Sampling
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#markov-chain-monte-carlo">
         1.2.1.2 Markov Chain Monte Carlo
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Gen Workflow</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#typical-workflow">
   1. Typical Workflow
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-generative-model">
     1.1. Define Generative Model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#random-choice-expressions">
       1.1.1. Random Choice Expressions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#rules-for-define-generative-function-with-dml">
       1.1.2. Rules For Define Generative Function With DML
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-inference-program">
     1.2. Define Inference Program
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#some-inference-algorithms">
       1.2.1. Some Inference Algorithms
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#importance-sampling">
         1.2.1.1 Importance Sampling
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#markov-chain-monte-carlo">
         1.2.1.2 Markov Chain Monte Carlo
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="section" id="gen-workflow">
<h1>Gen Workflow<a class="headerlink" href="#gen-workflow" title="Permalink to this headline">#</a></h1>
<div class="section" id="typical-workflow">
<h2>1. Typical Workflow<a class="headerlink" href="#typical-workflow" title="Permalink to this headline">#</a></h2>
<div class="section" id="define-generative-model">
<h3>1.1. Define Generative Model<a class="headerlink" href="#define-generative-model" title="Permalink to this headline">#</a></h3>
<p>generative functions can be either deterministic meaning it does not have random choice expression in it or
non-deterministic generative functions which has random choice expressions in it. either way generative function define
with <code class="docutils literal notranslate"><span class="pre">&#64;gen</span></code> macro. DML version of any generative function supports branching (if-end), loops (for-end, while-end) and
recursions. can use <code class="docutils literal notranslate"><span class="pre">&#64;trace</span></code> macro in generative functions which will eliminate the need of user defined addresses
because it will auto generate addresses from variable name.</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@gen</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="o">&lt;</span><span class="n">function_name</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">param_1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">param_2</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="o">&lt;</span><span class="k">function</span><span class="w"> </span><span class="n">body</span><span class="o">&gt;</span>

<span class="k">end</span>
</pre></div>
</div>
<p>deterministic generative functions like this,</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@gen</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">gen_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="random-choice-expressions">
<h4>1.1.1. Random Choice Expressions<a class="headerlink" href="#random-choice-expressions" title="Permalink to this headline">#</a></h4>
<p>random choice expression consists of two parts. one is the _address_ expression part and the other one is the
probabilistic distribution expression. it uses <code class="docutils literal notranslate"><span class="pre">~</span></code> instead of regular assignment operator. gen authors often use julia
symbols for address expression, but itâ€™s legal to use integers, tuples and strings. these random choice expressions can
be use in expression evaluation like normal.</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@gen</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">simple_gen_f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">normal</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">({</span><span class="ss">:b</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bernoulli</span><span class="p">(</span><span class="n">prob</span><span class="p">))</span>

<span class="k">end</span>
</pre></div>
</div>
<p>also generative functions can invoke another generative function inside it,</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@gen</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">robbed_model</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">({</span><span class="ss">:b</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bernoulli</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="w">        </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="ss">:w</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">robbed_model</span><span class="p">())</span>
<span class="w">        </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="ss">:r</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">robbed_model</span><span class="p">())</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
<p>itâ€™s possible to invoke other generative functions in DML without address expression by using <code class="docutils literal notranslate"><span class="pre">*</span></code> instead. but authors
highly discourage this invoking method.</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@gen</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">robbed_model</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">({</span><span class="ss">:b</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bernoulli</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="w">        </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="o">*</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">robbed_model</span><span class="p">())</span>
<span class="w">        </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="o">*</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">robbed_model</span><span class="p">())</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="rules-for-define-generative-function-with-dml">
<h4>1.1.2. Rules For Define Generative Function With DML<a class="headerlink" href="#rules-for-define-generative-function-with-dml" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>halts with probability 1</p></li>
</ul>
<p>for all values of generative function arguments it must halt with probability 1. infinite loops and infinite recursions
are not permitted.</p>
<ul class="simple">
<li><p>address must be unique</p></li>
</ul>
<p>any generative function must never sample a random choice at the same address twice.</p>
<ul class="simple">
<li><p>restricted use of randomness outside of random choice expressions</p></li>
</ul>
<p>randomness must be associate with either random choice expression or if it is outside of random choice expression it
must support future random choice expressions if not it must not affect to control flow. other than that every situation
make it un-valid generative function.</p>
<ul class="simple">
<li><p>restricted use of mutation</p></li>
</ul>
<p>generative functions permitted only to mutate its private variables. it should not mutate its arguments or any variable
outside its lexical scope.</p>
<ul class="simple">
<li><p>DML functions cannot be passed to julia higher-order functions</p></li>
</ul>
<p>an example from gen,</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@gen</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">poly_model</span><span class="p">(</span><span class="n">x_coordinates</span><span class="p">)</span>
<span class="w">    </span><span class="n">degree</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">uniform_discrete</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">inv_gammma</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">coefficients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[({(</span><span class="ss">:c</span><span class="p">,</span><span class="w"> </span><span class="kt">i</span><span class="p">)}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="n">degree</span><span class="p">]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">x_coordinates</span><span class="p">)</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coefficients</span><span class="o">&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="o">.^</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">degree</span><span class="p">)</span>

<span class="w">        </span><span class="p">{(</span><span class="ss">:y</span><span class="p">,</span><span class="w"> </span><span class="kt">i</span><span class="p">)}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

<span class="w">    </span><span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="define-inference-program">
<h3>1.2. Define Inference Program<a class="headerlink" href="#define-inference-program" title="Permalink to this headline">#</a></h3>
<p>inference program is a peace of julia code which use to manipulate inference model trace. how it does that is depends
on the inference algorithm choice. because different inference algorithms takes different set of parameters to execute
it.</p>
<p>how the trace data structure implemented, how probabilities and gradients are calculating and how conditional
independence is exploited by the modeling language compiler are hidden to make the abstract data type operations more
efficient.</p>
<div class="section" id="some-inference-algorithms">
<h4>1.2.1. Some Inference Algorithms<a class="headerlink" href="#some-inference-algorithms" title="Permalink to this headline">#</a></h4>
<div class="section" id="importance-sampling">
<h5>1.2.1.1 Importance Sampling<a class="headerlink" href="#importance-sampling" title="Permalink to this headline">#</a></h5>
<p>with simple MC can get properties from a distribution but with more sophisticated implementations can sample from
other distributions. this other distributions called <em>proposal distributions</em>. the simplest type of MC that uses this
proposal distribution is <em>importance sampling</em>. proposal distributions can represent as model distributions like
generative functions we discussed earlier.</p>
<p>there are different types of proposal are possible,</p>
<ul class="simple">
<li><p>proposal based on prior distribution</p></li>
<li><p>data driven proposals</p></li>
<li><p>algorithmic proposals</p></li>
<li><p>simulator-based proposals</p></li>
<li><p>neural network based proposals (fully or partially learned)</p></li>
</ul>
<p>there are two versions of the importance sampling in gen, returning log weights are normalised in both,</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">Gen.importance_sampling</span></code>: returning a vector of traces with associated log weights. <code class="docutils literal notranslate"><span class="pre">lml_est</span></code> are the estimate of the</dt><dd><p>marginal likelihood of the observations</p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">traces</span><span class="p">,</span><span class="w"> </span><span class="n">log_norm_weights</span><span class="p">,</span><span class="w"> </span><span class="n">lml_est</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importance_sampling</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">GenerativeFunction</span><span class="p">,</span>
<span class="w">                                                          </span><span class="n">model_args</span><span class="o">::</span><span class="kt">Tuple</span><span class="p">,</span>
<span class="w">                                                          </span><span class="n">observations</span><span class="o">::</span><span class="kt">ChoiceMap</span><span class="p">,</span>
<span class="w">                                                          </span><span class="n">num_samples</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span>
<span class="w">                                                          </span><span class="n">verbose</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Gen.importance_resampling</span></code>: returning a single trace, this sampling will not return log-weights</p></li>
</ul>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">lml_est</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importance_resampling</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">GenerativeFunction</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">model_args</span><span class="o">::</span><span class="kt">Tuple</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">observations</span><span class="o">::</span><span class="kt">ChoiceMap</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">num_samples</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">verbose</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
</pre></div>
</div>
<p>note: proposal distribution can directly give to these functions with the use of <code class="docutils literal notranslate"><span class="pre">proposal::GenerativeFunction</span></code> and
<code class="docutils literal notranslate"><span class="pre">proposal_args::Tuple</span></code> parameters.</p>
<p>two very important parameters are <code class="docutils literal notranslate"><span class="pre">num_samples</span></code> or number of samples and proposal distribution. increasing number of
samples will reduce error, but it comes with higher computational cost. choosing good proposal make inference algorithm
more efficient.</p>
<p>example,</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># generative function definition for linear regression model</span>

<span class="nd">@gen</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">model</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;&quot;&quot;fitting line with data&quot;&quot;&quot;</span>

<span class="w">    </span><span class="c"># proposal distribution in other words priors (or beliefs)</span>
<span class="w">    </span><span class="n">slope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="ss">:slope</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="n">intercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="ss">:intercept</span><span class="p">}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="w">        </span><span class="p">({(</span><span class="ss">:y</span><span class="p">,</span><span class="w"> </span><span class="kt">i</span><span class="p">)}</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">normal</span><span class="p">((</span><span class="n">slope</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intercept</span><span class="p">),</span><span class="w"> </span><span class="mf">0.1</span><span class="p">))</span>

<span class="w">    </span><span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># inference program for above generative model to make inference</span>

<span class="k">function</span><span class="w"> </span><span class="n">inf_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">model_args</span><span class="p">,</span><span class="w"> </span><span class="n">observations</span><span class="p">,</span><span class="w"> </span><span class="n">n_samples</span><span class="p">)</span>
<span class="w">    </span><span class="c"># create constrains aka condition (discussed in gen concept section)</span>
<span class="w">    </span><span class="c"># in here our observations (y-coordinates) set as constraints for</span>
<span class="w">    </span><span class="c"># the inference algorithm</span>
<span class="w">    </span><span class="n">obs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gen</span><span class="o">.</span><span class="n">choicemap</span><span class="p">()</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
<span class="w">        </span><span class="n">obs</span><span class="p">[(</span><span class="ss">:y</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">observations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">lml_est</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gen</span><span class="o">.</span><span class="n">importance_resampling</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">model_args</span><span class="p">,</span><span class="w"> </span><span class="n">observations</span><span class="p">,</span><span class="w"> </span><span class="n">n_samples</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">trace</span>

<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="markov-chain-monte-carlo">
<h5>1.2.1.2 Markov Chain Monte Carlo<a class="headerlink" href="#markov-chain-monte-carlo" title="Permalink to this headline">#</a></h5>
<p>MCMC is enables to algorithms that sample approximately from target probability distributions that are defined by
un-normalized density function and conditional distributions. generative function with MCMC initialize a state that
contains the values of latent random variables (unobserved values) and rapidly apply a stochastic kernel to this sate
and produce new state and keep going. one of important property of those kernels is they are stationary with respect to
the conditional distribution.</p>
<p>here some of genâ€™s stationary kernels,</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">metropolis_hastings</span></code>: gen has three variant of this and the simplest one is user provide set of random choices to be</dt><dd><p>updated without specifying how. second one allows user to use custom proposal or custom proposal
based on neural networks that are trained via amortized inference. the last one allows user to
specify any kernel in the reversible jump MCMC framework.</p>
</dd>
</dl>
</li>
</ul>
<p>to perform Metropolis-Hastings update that proposes new values for the selected addresses from the internal proposal,
.. code:: julia</p>
<blockquote>
<div><dl class="simple">
<dt>(new_trace, accepted) = metropolis_hastings(trace,</dt><dd><p>selection::Selection;
check=false,
observations=EmptyChoiceMap())</p>
</dd>
</dl>
</div></blockquote>
<p>to perform Metropolis-Hastings update that proposes new values for some subset of random choices in the given trace
using the given proposal generative function, returning the new trace and a Bool indicating whether the move was
accepted or not.</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">new_trace</span><span class="p">,</span><span class="w"> </span><span class="n">accepted</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metropolis_hastings</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">proposal</span><span class="o">::</span><span class="kt">GenerativeFunction</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">proposal_args</span><span class="o">::</span><span class="kt">Tuple</span><span class="p">;</span>
<span class="w">                                            </span><span class="n">check</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">observations</span><span class="o">=</span><span class="n">EmptyChoiceMap</span><span class="p">())</span>
</pre></div>
</div>
<p>perform a generalized Metropolis Hastings update based on an involution on space of choice maps. returning the new trace and a Bool indicating whether the move was
accepted or not.</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">new_trace</span><span class="p">,</span><span class="w"> </span><span class="n">accepted</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metropolis_hastings</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">proposal</span><span class="o">::</span><span class="kt">GenerativeFunction</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">proposal_args</span><span class="o">::</span><span class="kt">Tuple</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">involution</span><span class="o">::</span><span class="kt">Union</span><span class="p">{</span><span class="kt">TraceTransformDSLProgram</span><span class="p">,</span><span class="kt">Function</span><span class="p">};</span>
<span class="w">                                            </span><span class="n">check</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">observations</span><span class="o">=</span><span class="n">EmptyChoiceMap</span><span class="p">())</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mala</span></code>: performs a Metropolis Adjusted Langevin algorithm update on a set of selected random choices.</p></li>
</ul>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">new_trace</span><span class="p">,</span><span class="w"> </span><span class="n">accepted</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mala</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span>
<span class="w">                             </span><span class="n">selection</span><span class="o">::</span><span class="kt">Selection</span><span class="p">,</span>
<span class="w">                             </span><span class="n">tau</span><span class="o">::</span><span class="kt">Real</span><span class="p">;</span>
<span class="w">                             </span><span class="n">check</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span>
<span class="w">                             </span><span class="n">observations</span><span class="o">=</span><span class="n">EmptyChoiceMap</span><span class="p">())</span>
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">hmc</span></code>: performs a Hamiltonian Monte Carlo update on a set of selected random choices. this is also a selection based</dt><dd><p>inference operators which user need to provide set of addresses (random choices) that act on traces.</p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">new_trace</span><span class="p">,</span><span class="w"> </span><span class="n">accepted</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hmc</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span>
<span class="w">                            </span><span class="n">selection</span><span class="o">::</span><span class="kt">Selection</span><span class="p">;</span>
<span class="w">                            </span><span class="n">L</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="w">                            </span><span class="n">check</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span>
<span class="w">                            </span><span class="n">observations</span><span class="o">=</span><span class="n">EmptyChoiceMap</span><span class="p">())</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">elliptical_slice</span></code>:  performs an elliptical slice sampling update on a selected multivariate normal random choice.</p></li>
</ul>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">new_trace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elliptical_slice</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span>
<span class="w">                             </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">cov</span><span class="p">;</span>
<span class="w">                             </span><span class="n">check</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span>
<span class="w">                             </span><span class="n">observations</span><span class="o">=</span><span class="n">EmptyChoiceMap</span><span class="p">())</span>
</pre></div>
</div>
<p>example,</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># inference program which use metropolis hastings as selection based operator</span>

<span class="k">function</span><span class="w"> </span><span class="n">inf_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">model_args</span><span class="p">,</span><span class="w"> </span><span class="n">observations</span><span class="p">,</span><span class="w"> </span><span class="n">n_samples</span><span class="p">)</span>
<span class="w">    </span><span class="n">obs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gen</span><span class="o">.</span><span class="n">choicemap</span><span class="p">()</span>

<span class="w">    </span><span class="c"># create constrains aka condition</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
<span class="w">        </span><span class="n">obs</span><span class="p">[(</span><span class="ss">:y</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">observations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c"># to get an initial execution trace</span>
<span class="w">    </span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">accepted</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">model_args</span><span class="p">,</span><span class="w"> </span><span class="n">observations</span><span class="p">)</span>

<span class="w">    </span><span class="c"># provide selected random choice to mh</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">n_samples</span>
<span class="w">        </span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">accepted</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metropolis_hastings</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="ss">:slope</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">accepted</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metropolis_hastings</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="ss">:intercept</span><span class="p">))</span>

<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">choices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_choices</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="ss">:slope</span><span class="p">],</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="ss">:intercept</span><span class="p">])</span>

<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Gen.jl Workflow</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By ashen007<br/>
  
      &copy; Copyright 2023, ashen007.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>